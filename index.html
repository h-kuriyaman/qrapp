<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードスキャン</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <h2>QRコードスキャン</h2>
    <div id="reader" style="width: 300px;"></div>
    <h3>スキャン結果</h3>
    <table border="1">
        <thead>
            <tr>
                <th>元データ</th>
                <th>頭3文字</th>
                <th>次の7文字</th>
            </tr>
        </thead>
        <tbody id="result-table"></tbody>
    </table>
    <button onclick="downloadCSV()">CSVダウンロード</button>

    <script>
        let scannedData = [];

        function onScanSuccess(decodedText) {
            const table = document.getElementById("result-table");
            const newRow = document.createElement("tr");

            // データを分割
            let head3 = decodedText.substring(0, 3);
            let next7 = decodedText.substring(3, 10);

            newRow.innerHTML = `
                <td>${decodedText}</td>
                <td>${head3}</td>
                <td>${next7}</td>
            `;
            table.appendChild(newRow);

            // 配列に保存
            scannedData.push([decodedText, head3, next7]);
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "元データ,頭3文字,次の7文字\n";
            scannedData.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            // CSVダウンロード
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "qr_scan_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, // 背面カメラ
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        ).catch(err => console.error(err));
    </script>
</body>
</html>
