<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰åŒæœŸ</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <h1>QRã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ</h1>
    <ul id="qrList"></ul>

    <!-- QRã‚³ãƒ¼ãƒ‰ã‚«ãƒ¡ãƒ©è¡¨ç¤ºç”¨ -->
    <div id="reader" style="width: 300px; height: 300px;"></div>
    <p id="result">ã‚¹ã‚­ãƒ£ãƒ³çµæœ: </p>
    
    <button id="exportCsvBtn">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="exportExcelBtn">Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

    <script>
        // ğŸ”¹ Firebaseã®è¨­å®šï¼ˆã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyBXjJ5dro9a1T_h1VSUH0mgRRgDZh75_sQ",
            authDomain: "gakko-digital-list.firebaseapp.com",
            databaseURL: "https://gakko-digital-list-default-rtdb.firebaseio.com/",
            projectId: "gakko-digital-list",
            storageBucket: "gakko-digital-list.appspot.com",
            messagingSenderId: "232515270216",
            appId: "1:232515270216:web:3e90029e1c17e369e7ca7d"
        };

        // ğŸ”¹ Firebase åˆæœŸåŒ–
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let qrData = [];  // QRã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—

        // ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã—ã¦è¡¨ç¤º
        database.ref("qrcodes").on("value", (snapshot) => {
            const qrList = document.getElementById("qrList");
            qrList.innerHTML = "";  // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            qrData = [];  // é…åˆ—ã‚’ãƒªã‚»ãƒƒãƒˆ

            snapshot.forEach((childSnapshot) => {
                const qrValue = childSnapshot.val();
                qrData.push(qrValue);  // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’é…åˆ—ã«è¿½åŠ 

                const li = document.createElement("li");
                li.textContent = qrValue;  // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’ãƒªã‚¹ãƒˆã«è¡¨ç¤º
                qrList.appendChild(li);
            });
        });

        // ğŸ”¹ QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ãŸéš›ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
        function onScanSuccess(decodedText, decodedResult) {
            // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’è¡¨ç¤º
            document.getElementById("result").innerText = "ã‚¹ã‚­ãƒ£ãƒ³çµæœ: " + decodedText;

            // ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’Firebaseã«ä¿å­˜
            database.ref("qrcodes").push(decodedText);
        }

        function onScanError(errorMessage) {
            console.warn(errorMessage);
        }

        // QRã‚³ãƒ¼ãƒ‰ã®ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã¨èª­ã¿å–ã‚Šé–‹å§‹
        function startQRScanner() {
            let html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess, onScanError);
        }

        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ã«QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’èµ·å‹•
        window.onload = function() {
            startQRScanner();
        }

        // ğŸ”¹ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToCSV() {
            const csvData = qrData.map(qrValue => {
                const first3 = qrValue.slice(0, 3);  // é ­3æ–‡å­—
                const next7 = qrValue.slice(3, 10); // ãã®å¾Œ7æ–‡å­—
                return `${qrValue},${first3},${next7}`;
            });
            const csvContent = "QRã‚³ãƒ¼ãƒ‰,é ­3æ–‡å­—,ãã®å¾Œ7æ–‡å­—\n" + csvData.join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
            saveAs(blob, "qrcodes.csv");
        }

        // ğŸ”¹ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToExcel() {
            const ws = XLSX.utils.aoa_to_sheet([
                ["QRã‚³ãƒ¼ãƒ‰", "é ­3æ–‡å­—", "ãã®å¾Œ7æ–‡å­—"],
                ...qrData.map(qrValue => {
                    const first3 = qrValue.slice(0, 3);
                    const next7 = qrValue.slice(3, 10);
                    return [qrValue, first3, next7];
                })
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "QRã‚³ãƒ¼ãƒ‰");
            XLSX.writeFile(wb, "qrcodes.xlsx");
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById("exportCsvBtn").addEventListener("click", exportToCSV);
        document.getElementById("exportExcelBtn").addEventListener("click", exportToExcel);
    </script>
</body>
</html>
