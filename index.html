<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</title>
</head>
<body>
    <h2>QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼</h2>
    <video id="video" width="300" height="200" autoplay></video>
    <canvas id="canvas" hidden></canvas>
    <p>èª­ã¿å–ã£ãŸQRã‚³ãƒ¼ãƒ‰: <span id="result"></span></p>

    <h3>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</h3>
    <table border="1">
        <thead>
            <tr>
                <th>å…ƒã®ãƒ‡ãƒ¼ã‚¿</th>
                <th>é ­3æ–‡å­—</th>
                <th>æ¬¡ã®7æ–‡å­—</th>
            </tr>
        </thead>
        <tbody id="history"></tbody>
    </table>
    <button onclick="downloadCSV()">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script> <!-- QRã‚³ãƒ¼ãƒ‰è§£æç”¨ -->

    <script>
        // ğŸ”¹ Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBXjJ5dro9a1T_h1VSUH0mgRRgDZh75_sQ",
            authDomain: "gakko-digital-list.firebaseapp.com",
            databaseURL: "https://gakko-digital-list-default-rtdb.firebaseio.com/",
            projectId: "gakko-digital-list",
            storageBucket: "gakko-digital-list.appspot.com",
            messagingSenderId: "232515270216",
            appId: "1:232515270216:web:3e90029e1c17e369e7ca7d"
        };

        // Firebaseã®åˆæœŸåŒ–
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼é–¢é€£
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        const resultElement = document.getElementById("result");
        const historyTable = document.getElementById("history");

        let lastScanned = ""; // ç›´å‰ã®QRã‚³ãƒ¼ãƒ‰
        let scanning = false; // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ãƒ•ãƒ©ã‚°

        // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then((stream) => {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                scanQRCode();
            })
            .catch((err) => console.error("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“", err));

        function scanQRCode() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

                if (qrCode) {
                    const fullData = qrCode.data;

                    // åŒã˜QRã‚³ãƒ¼ãƒ‰ã®é€£ç¶šç™»éŒ²ã‚’é˜²ã
                    if (fullData === lastScanned || scanning) {
                        requestAnimationFrame(scanQRCode);
                        return;
                    }

                    scanning = true;  // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ãƒ•ãƒ©ã‚°ON
                    lastScanned = fullData;  // ç›´å‰ã®QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜

                    const head3 = fullData.substring(0, 3);
                    const next7 = fullData.substring(3, 10);
                    resultElement.textContent = fullData;

                    // Firebaseã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                    const dataRef = database.ref('scannedData');
                    dataRef.push({
                        fullData: fullData,
                        head3: head3,
                        next7: next7
                    });

                    // ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã‚’ç”»é¢ã«è¿½åŠ 
                    addToHistory(fullData, head3, next7);

                    // 3ç§’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’è¨±å¯
                    setTimeout(() => {
                        scanning = false;
                    }, 3000);
                }
            }
            requestAnimationFrame(scanQRCode);
        }

        // Firebaseã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ç›£è¦–
        const dataRef = database.ref('scannedData');
        dataRef.on('child_added', function(snapshot) {
            const scanData = snapshot.val();
            addToHistory(scanData.fullData, scanData.head3, scanData.next7);
        });

        // ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
        function addToHistory(fullData, head3, next7) {
            const row = historyTable.insertRow();
            row.insertCell(0).textContent = fullData;
            row.insertCell(1).textContent = head3;
            row.insertCell(2).textContent = next7;
        }

        function downloadCSV() {
            let csvContent = "å…ƒã®ãƒ‡ãƒ¼ã‚¿,é ­3æ–‡å­—,æ¬¡ã®7æ–‡å­—\n";

            // Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            database.ref('scannedData').once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    const data = childSnapshot.val();
                    csvContent += `${data.fullData},${data.head3},${data.next7}\n`;
                });

                // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "qr_scan_history.csv";
                link.click();
            });
        }
    </script>
</body>
</html>
